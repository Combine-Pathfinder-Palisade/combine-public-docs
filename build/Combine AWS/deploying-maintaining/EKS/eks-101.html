<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Combine AWS/deploying-maintaining/EKS/eks-101" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.6.3">
<title data-rh="true">EKS 101 | Combine Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://combine-pathfinder-palisade.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://combine-pathfinder-palisade.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://combine-pathfinder-palisade.github.io/Combine AWS/deploying-maintaining/EKS/eks-101"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="EKS 101 | Combine Docs"><meta data-rh="true" name="description" content="What is EKS? How do you support it? It&#x27;s a lot of fun!"><meta data-rh="true" property="og:description" content="What is EKS? How do you support it? It&#x27;s a lot of fun!"><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="https://combine-pathfinder-palisade.github.io/Combine AWS/deploying-maintaining/EKS/eks-101"><link data-rh="true" rel="alternate" href="https://combine-pathfinder-palisade.github.io/Combine AWS/deploying-maintaining/EKS/eks-101" hreflang="en"><link data-rh="true" rel="alternate" href="https://combine-pathfinder-palisade.github.io/Combine AWS/deploying-maintaining/EKS/eks-101" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.08596512.css">
<script src="/assets/js/runtime~main.6f2e520c.js" defer="defer"></script>
<script src="/assets/js/main.8ebae3d5.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/favicon.png" alt="Combine Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/favicon.png" alt="Combine Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Combine Docs</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/category/developing">The Docs</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/about">About</a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input id="search_input_react" type="search" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/category/developing">Combine AWS</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/category/developing">Developing</a><button aria-label="Expand sidebar category &#x27;Developing&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/category/deployingmaintaining">Deploying/Maintaining</a><button aria-label="Collapse sidebar category &#x27;Deploying/Maintaining&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/category/how-tos">How-Tos</a><button aria-label="Expand sidebar category &#x27;How-Tos&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/Combine AWS/deploying-maintaining/EKS/eks-101">EKS</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/Combine AWS/deploying-maintaining/EKS/eks-101">EKS 101</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/Combine AWS/deploying-maintaining/account-switching">Account Switch Links</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/Combine AWS/deploying-maintaining/aws-customer-contacts">Customer Contacts Spreadsheet</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/Combine AWS/deploying-maintaining/full-deploy">Full Deploy Process</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/Combine AWS/deploying-maintaining/minor-upgrade">Minor Upgrade</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/Combine AWS/deploying-maintaining/other-commands">Other Commands</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/Combine AWS/deploying-maintaining/support-duties">Support Duties</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/category/combine-features">Combine Features</a><button aria-label="Expand sidebar category &#x27;Combine Features&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Combine AWS</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/category/deployingmaintaining"><span itemprop="name">Deploying/Maintaining</span></a><meta itemprop="position" content="2"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">EKS</span><meta itemprop="position" content="3"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">EKS 101</span><meta itemprop="position" content="4"></li></ul></nav><div class="theme-doc-markdown markdown"><header><h1>EKS 101</h1></header>
<p>What is EKS? How do you support it? It&#x27;s a lot of fun!</p>
<p>Raw content from discussions with Matt:</p>
<p>Notes from EKS Session with Matt:</p>
<ul>
<li>If a new customer wants/needs to use combine imds proxy (we only want to give it to them if the NEED to use IMDS, but it’ll require a code change anyway, so they might not want to use it after all)<!-- -->
<ul>
<li>pull it down from our public ECR, push back up to their own ECR from within Combine</li>
<li>Action Item for each of us - look at the combine-proxy-imds repo, the docs are very nice</li>
</ul>
</li>
<li>learn how the customer is deploying EKS<!-- -->
<ul>
<li>through terraform, or some other means</li>
<li>there’s configuration in terraform vs just EKS in the console<!-- -->
<ul>
<li>more often than not customers use terraform</li>
</ul>
</li>
</ul>
</li>
<li>Things to tell them<!-- -->
<ul>
<li>EKS nodes need to be able to trust the Combine CA chain (like we do for normal VMs)</li>
<li>A lot of things around IRSA (IAM Roles for Service Accounts)<!-- -->
<ul>
<li><code>IRSA</code> needs to have the emulated IAM ARNs, because they run on the nodes inside the Combine VPC</li>
<li><code>aws-auth</code> config map needs to be commercial</li>
</ul>
</li>
<li>only thing in the kubeconfig that gets emulated is the server endpoint url</li>
<li>EBS-CSI driver versions newer than 1.32 return a new CreateVolume topology name<!-- -->
<ul>
<li>but we got around this by adding the user agent fix (Daniel will update this message with a link to that fix, it was with SF before Stephen left)</li>
</ul>
</li>
<li>Miscellaneous<!-- -->
<ul>
<li>there are cases where customers will need an ingress subnet<!-- -->
<ul>
<li>there’s a load balancer controller plugin that can set up load balancers as ingresses into the cluster</li>
</ul>
</li>
</ul>
</li>
<li>IMDS Proxy improvements (IMDS PROXY DEPRECATED, DO NOT TALK ABOUT IT)<!-- -->
<ul>
<li>some endpoints needs to be updated</li>
</ul>
</li>
<li>When a pod stands up in k8s, it doesn’t have an IP. So when it makes its first call to the IMDS proxy, it’s IP might not be in the list of approved IPs; the proxy might reject it. As part of that process, proxy will refresh its list of IPs, then if it’s still not in there, then it’ll reject it. The refresh might be fast enough that it ‘beats’ the IP assigned to the pod<!-- -->
<ul>
<li>in the case of the ebs-csi driver, it only tries twice before giving up</li>
<li>i.e. there needs to be an improvement with how the refresh works, maybe set up an exponential backoff</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Some good resources</p>
<ul>
<li>IRSA - IAM roles for Service Accounts Article - <a href="https://medium.com/@ankit.wal/the-how-of-iam-roles-for-service-accounts-irsa-on-aws-eks-3d76badb8942" target="_blank" rel="noopener noreferrer">https://medium.com/@ankit.wal/the-how-of-iam-roles-for-service-accounts-irsa-on-aws-eks-3d76badb8942</a></li>
<li>4 hour YouTube course on Vanilla Kubernetes - <a href="https://www.youtube.com/watch?v=X48VuDVv0do" target="_blank" rel="noopener noreferrer">https://www.youtube.com/watch?v=X48VuDVv0do</a></li>
<li>Full EKS course on Kubernetes (don’t know of any right now)</li>
<li>the kubernetes config parameters in the emulation.config in combine-aws</li>
<li>the kubernetes rewriters in combine-aws</li>
<li><code>combine-imds-proxy</code> repository (only for historical purposes)</li>
</ul>
<hr>
<p>the cluster role in cisco has these permissions</p>
<ul>
<li>eks cluster policy</li>
<li>eks cluster vpc controller</li>
<li>allow for KMS, required for EKS encryption<!-- -->
<ul>
<li>there&#x27;s no way to set EKS encryption at the customer for TS</li>
<li>the permissions on WLDEVELOPER do not support creating a KMS key grant, and the permissions on the KeyManager role do not let them list eks clusters</li>
</ul>
</li>
<li>deny for resource groups</li>
</ul>
<p>Users can create roles as long as they&#x27;re prefixed by PROJECT_ and bounded by the Permissions Boundary <code>PB-WLDEVELOPER</code>, required by S or TS customer</p>
<p>EVERY ROLE related to EKS has to be prefixed by PROJECT_</p>
<p>TO stand up a cluster</p>
<ol>
<li>create role</li>
<li>create cluster</li>
<li>create oidc provider</li>
</ol>
<ul>
<li>not done by WLDEVELOPER, (Cisco uses CUSTOMERIT) or a Sequoia admin</li>
</ul>
<p>Repeat steps 1 &amp; 2 for the node groups,</p>
<ol>
<li>Create node group role(s)</li>
<li>create node groups</li>
</ol>
<p>For VPC-only clusters: if the SG on the cluster does not include the cidr block of the node groups, the node groups will not be able to join the cluster. Does not apply to public clusters.</p>
<p>OIDC provider is there for IRSA. service accounts can use the OIDC provider to assume a role in AWS</p>
<p>once the cluster is created, you take the OIDC provider url and put in the trust policy</p>
<p>trust policy for a PROJECT_aws-ebs-csi-driver-controller POD role:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;Version&quot;: &quot;2012-10-17&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;Statement&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;Effect&quot;: &quot;Allow&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;Principal&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;Federated&quot;: &quot;arn:aws:iam::663117128738:oidc-provider/oidc.eks.us-east-1.amazonaws.com/id/7435A97694DAE25C2079AC8D8B66D242&quot; oidc provider arn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;Action&quot;: &quot;sts:AssumeRoleWithWebIdentity&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;Condition&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;StringEquals&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot;oidc.eks.us-east-1.amazonaws.com/id/7435A97694DAE25C2079AC8D8B66D242:sub&quot;: &quot;system:serviceaccount:kube-system:ebs-csi-controller-sa&quot;, needs to be the &#x27;path&#x27; of the service account </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot;oidc.eks.us-east-1.amazonaws.com/id/7435A97694DAE25C2079AC8D8B66D242:aud&quot;: &quot;sts.amazonaws.com&quot; needs to match the sts endpoint on the oidc provider, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;Sid&quot;: &quot;CombineInjectedServicePrincipal&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;Effect&quot;: &quot;Allow&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;Principal&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;AWS&quot;: &quot;arn:aws:iam::663117128738:root&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;Action&quot;: &quot;sts:AssumeRole&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Service Account sample:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;kind&quot;: &quot;ServiceAccount&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;apiVersion&quot;: &quot;v1&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;metadata&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;name&quot;: &quot;ebs-csi-controller-sa&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;namespace&quot;: &quot;kube-system&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;uid&quot;: &quot;8339dcbd-119b-4f5f-84ae-a1e7a8c24192&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;resourceVersion&quot;: &quot;179402&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;creationTimestamp&quot;: &quot;2024-09-18T21:56:08Z&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;labels&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;app.kubernetes.io/component&quot;: &quot;csi-driver&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;app.kubernetes.io/instance&quot;: &quot;aws-ebs-csi-driver&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;app.kubernetes.io/managed-by&quot;: &quot;Helm&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;app.kubernetes.io/name&quot;: &quot;aws-ebs-csi-driver&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;app.kubernetes.io/version&quot;: &quot;1.33.0&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;helm.sh/chart&quot;: &quot;aws-ebs-csi-driver-2.33.0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;annotations&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;eks.amazonaws.com/audience&quot;: &quot;sts.amazonaws.com&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;eks.amazonaws.com/role-arn&quot;: &quot;arn:aws-iso:iam::663117128738:role/PROJECT_aws-ebs-csi-driver-controller&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;meta.helm.sh/release-name&quot;: &quot;aws-ebs-csi-driver&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;meta.helm.sh/release-namespace&quot;: &quot;kube-system&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;automountServiceAccountToken&quot;: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>the annotations matter, the audience has to match the sts endpoint from above, the role arn needs to match the role
the pod will get created with an sts token that has the role</p>
<p>here&#x27;s a pod that&#x27;s using the irsa
the serviceAccountToken listed in the voume needs to match the audience for the STS account token
the aws-iam-token volume is the one to look at
this automount is a flag in most helm charts <a href="https://github.com/kubernetes-sigs/aws-ebs-csi-driver/blob/master/charts/aws-ebs-csi-driver/values.yaml#L397" target="_blank" rel="noopener noreferrer">https://github.com/kubernetes-sigs/aws-ebs-csi-driver/blob/master/charts/aws-ebs-csi-driver/values.yaml#L397</a></p>
<p>The terraform in <code>combine-terraform</code> does this; release sparingly to customers, as it is very complex and requires helm and other stuff.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/Combine-Pathfinder-Palisade/combine-docs/blob/main/docs/Combine AWS/deploying-maintaining/EKS/eks-101.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2025-02-10T21:35:22.000Z" itemprop="dateModified">Feb 10, 2025</time></b> by <b>github-actions</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/Combine AWS/deploying-maintaining/how-tos/how-to-update-service-parity"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">How To: Update Combine Service Parity Definitions</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/Combine AWS/deploying-maintaining/account-switching"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Account Switch Links</div></a></nav></div></div></div></div></main></div></div></div></div>
</body>
</html>